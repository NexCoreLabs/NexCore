<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Cookie consent stylesheet (GA will only be injected after consent) -->
        <link rel="stylesheet" href="assets/css/cookie-consent.css">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="NexCore Labs dashboard for teams to manage projects, and resources.">
        <meta name="author" content="NexCore Labs">
        <meta name="keywords" content="NexCore Labs, dashboard, team, projects, student projects, Sultan Qaboos University, Oman">
        <meta name="theme-color" content="#0a0b1c">
        <meta name="mobile-web-app-capable" content="yes">

        <meta property="og:url" content="https://nexcorelabs.vercel.app/dashboard.html">
        <meta property="og:type" content="website">
        <meta property="og:title" content="NexCore Labs | Dashboard">
        <meta property="og:description" content="Team dashboard for managing NexCore Labs projects.">

        <meta name="twitter:card" content="summary_large_image">
        <meta property="twitter:domain" content="nexcorelabs.vercel.app">
        <meta property="twitter:url" content="https://nexcorelabs.vercel.app/dashboard.html">
        <meta name="twitter:title" content="NexCore Labs | Dashboard">
        <meta name="twitter:description" content="Team dashboard for managing NexCore Labs projects.">

        <title>NexCore Labs | Dashboard</title>

        <link rel="icon" href="assets/images/nexcore-icon.png" type="image/png">
        <link rel="stylesheet" href="assets/css/unminified-css.css">
        <link rel="manifest" href="manifest.json">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
        <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.4.2/uicons-solid-rounded/css/uicons-solid-rounded.css'>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .wrap{max-width:980px;margin:60px auto;padding:16px}
    .box{border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:16px;margin:14px 0;background:rgba(10,11,28,.35)}
    label{display:block;margin:10px 0 6px;opacity:.9}
    input,textarea{
      width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);color:#fff
    }
    textarea{min-height:110px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:#fff;cursor:pointer}
    .btnPrimary{background:rgba(110,231,243,.18);border-color:rgba(110,231,243,.35)}
    .muted{opacity:.75}
    .danger{border-color:rgba(255,120,120,.4);background:rgba(255,120,120,.12)}
    a{color:#6ee7f3}
  </style>
</head>
<body>

  <div class="wrap">
    <h1>Dashboard</h1>
    <p class="muted" id="userLine">Loading…</p>

    <div class="box">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">My Project</h2>
        <div class="row">
          <button class="btn" id="logoutBtn">Logout</button>
        </div>
      </div>

      <!-- State: no project -->
      <div id="noProject" style="display:none;margin-top:12px;">
        <p>You don’t have a project yet.</p>
        <div class="row">
          <input id="newProjectName" placeholder="Project name (e.g., Sovlex)" />
          <button class="btn btnPrimary" id="createProjectBtn">Create Project</button>
        </div>
        <p class="muted" style="margin-top:10px;">
          A draft card/profile will be created. You can edit and publish when ready.
        </p>
      </div>

      <!-- State: has project -->
      <div id="hasProject" style="display:none;margin-top:12px;">
        <p class="muted">
          Public ID: <b id="publicId"></b> • Status: <b id="statusText"></b>
        </p>
        <p class="muted">
          Public link:
          <a id="publicLink" href="#" target="_blank" rel="noopener">open</a>
        </p>

        <label>Project name</label>
        <input id="name" />

        <label>Slug (used in link)</label>
        <input id="slug" placeholder="sovlex" />

        <label>Image URL (optional)</label>
        <input id="image_url" placeholder="https://..." />
        <div style="margin-top:10px;">
          <img id="imgPreview" alt="" style="max-width:240px;border-radius:14px;display:none;border:1px solid rgba(255,255,255,.10);" />
        </div>

        <label>Description</label>
        <textarea id="description"></textarea>

        <div class="row" style="margin-top:12px;">
          <button class="btn btnPrimary" id="saveBtn">Save</button>
          <button class="btn" id="togglePublishBtn">Publish</button>
          <button class="btn danger" id="deleteBtn" style="margin-left:auto;">Delete Project</button>
        </div>

        <p class="muted" id="msg" style="margin-top:10px;"></p>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/js/supabase-client.js"></script>
  <script src="assets/js/auth-ui.js"></script>

  <script>
    const sb = window.supabaseClient; // matches your supabase-client.js

    function setMsg(text) {
      document.getElementById("msg").textContent = text || "";
    }

    function slugify(s) {
      return (s || "")
        .toLowerCase()
        .trim()
        .replace(/[^a-z0-9]+/g, "-")
        .replace(/^-+|-+$/g, "")
        .slice(0, 40);
    }

    let project = null;

    function render(p) {
      project = p;

      document.getElementById("noProject").style.display = p ? "none" : "block";
      document.getElementById("hasProject").style.display = p ? "block" : "none";

      if (!p) return;

      document.getElementById("publicId").textContent = p.public_id || "";
      document.getElementById("statusText").textContent = p.published ? "Published" : "Draft";

      const publishBtn = document.getElementById("togglePublishBtn");
      publishBtn.textContent = p.published ? "Unpublish" : "Publish";

      document.getElementById("name").value = p.name || "";
      document.getElementById("slug").value = p.slug || "";
      document.getElementById("image_url").value = p.image_url || "";
      document.getElementById("description").value = p.description || "";

      const link = `/project.html?slug=${encodeURIComponent(p.slug || "")}`;
      const a = document.getElementById("publicLink");
      a.href = link;
      a.textContent = link;

      const img = document.getElementById("imgPreview");
      if (p.image_url && p.image_url.startsWith("http")) {
        img.src = p.image_url;
        img.style.display = "inline-block";
      } else {
        img.style.display = "none";
      }
    }

    async function requireAuth() {
      const { data: { session } } = await sb.auth.getSession();
      if (!session) {
        window.location.href = "/auth.html";
        return null;
      }
      
      // Show onboarding message based on auth mode
      const authMode = sessionStorage.getItem('auth_mode');
      let welcomeMsg = `Signed in as ${session.user.email}`;
      
      if (authMode === 'signup') {
        welcomeMsg += ' — Welcome to NexCore Labs! Create your first project below.';
        sessionStorage.removeItem('auth_mode');
      } else if (authMode === 'login') {
        welcomeMsg += ' — Welcome back.';
        sessionStorage.removeItem('auth_mode');
      }
      
      document.getElementById("userLine").textContent = welcomeMsg;
      return session;
    }

    async function loadMyProject() {
      setMsg("");
      const { data, error } = await sb
        .from("projects")
        .select("*")
        .limit(1);

      if (error) {
        setMsg(error.message);
        render(null);
        return;
      }
      render(data && data[0] ? data[0] : null);
    }

    async function createProject() {
      setMsg("");
      const name = document.getElementById("newProjectName").value.trim();
      if (!name) return setMsg("Please enter a project name.");

      const slug = slugify(name);
      if (!slug) return setMsg("Invalid project name.");

      const { data, error } = await sb
        .from("projects")
        .insert({ name, slug })   // public_id auto by trigger
        .select("*")
        .single();

      if (error) return setMsg(error.message);

      render(data);
      setMsg("Project created (draft) ✅ Now edit and publish when ready.");
    }

    async function saveProject() {
      setMsg("");
      if (!project) return;

      const name = document.getElementById("name").value.trim();
      const slug = slugify(document.getElementById("slug").value.trim() || name);
      const image_url = document.getElementById("image_url").value.trim();
      const description = document.getElementById("description").value.trim();

      const { data, error } = await sb
        .from("projects")
        .update({
          name,
          slug,
          image_url,
          description,
          updated_at: new Date().toISOString()
        })
        .eq("id", project.id)
        .select("*")
        .single();

      if (error) return setMsg(error.message);

      render(data);
      setMsg("Saved ✅");
    }

    async function togglePublish() {
      setMsg("");
      if (!project) return;

      const next = !project.published;

      const { data, error } = await sb
        .from("projects")
        .update({
          published: next,
          updated_at: new Date().toISOString()
        })
        .eq("id", project.id)
        .select("*")
        .single();

      if (error) return setMsg(error.message);

      render(data);
      setMsg(next ? "Published ✅ (will appear in Hub later)" : "Unpublished (hidden from Hub)");
    }

    async function deleteProject() {
      if (!project) return;

      const ok = confirm("Delete your project permanently? This cannot be undone.");
      if (!ok) return;

      setMsg("");
      const { error } = await sb
        .from("projects")
        .delete()
        .eq("id", project.id);

      if (error) return setMsg(error.message);

      render(null);
      setMsg("Project deleted.");
    }

    async function logout() {
      await sb.auth.signOut();
      window.location.href = "/auth.html";
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const session = await requireAuth();
      if (!session) return;

      document.getElementById("logoutBtn").addEventListener("click", logout);
      document.getElementById("createProjectBtn").addEventListener("click", createProject);
      document.getElementById("saveBtn").addEventListener("click", saveProject);
      document.getElementById("togglePublishBtn").addEventListener("click", togglePublish);
      document.getElementById("deleteBtn").addEventListener("click", deleteProject);

      document.getElementById("image_url").addEventListener("input", (e) => {
        const url = e.target.value.trim();
        const img = document.getElementById("imgPreview");
        if (url.startsWith("http")) {
          img.src = url;
          img.style.display = "inline-block";
        } else {
          img.style.display = "none";
        }
      });

      await loadMyProject();
    });
  </script>
        <script src="assets/js/cookie-consent.js" defer></script>
</body>
</html>