<!DOCTYPE html>
<html lang="en">
    <head>
        <!-- Cookie consent stylesheet (GA will only be injected after consent) -->
        <link rel="stylesheet" href="assets/css/cookie-consent.css">
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Manage your NexCore Labs account settings.">
        <meta name="author" content="NexCore Labs">
        <meta name="keywords" content="NexCore Labs, account, settings, profile, Sultan Qaboos University, Oman">
        <meta name="theme-color" content="#0a0b1c">
        <meta name="mobile-web-app-capable" content="yes">

        <meta property="og:url" content="https://nexcorelabs.vercel.app/account.html">
        <meta property="og:type" content="website">
        <meta property="og:title" content="NexCore Labs | Account Settings">
        <meta property="og:description" content="Manage your NexCore Labs account settings.">

        <meta name="twitter:card" content="summary_large_image">
        <meta property="twitter:domain" content="nexcorelabs.vercel.app">
        <meta property="twitter:url" content="https://nexcorelabs.vercel.app/account.html">
        <meta name="twitter:title" content="NexCore Labs | Account Settings">
        <meta name="twitter:description" content="Manage your NexCore Labs account settings.">

        <title>NexCore Labs | Account Settings</title>

        <link rel="icon" href="assets/images/nexcore-icon.png" type="image/png">
        <!-- <link rel="stylesheet" href="assets/css/style.css"> -->
        <link rel="stylesheet" href="assets/css/unminified-css.css">
        <link rel="manifest" href="manifest.json">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap" rel="stylesheet">
        <link rel='stylesheet' href='https://cdn-uicons.flaticon.com/2.4.2/uicons-solid-rounded/css/uicons-solid-rounded.css'>
        <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>

    .wrap{max-width:680px;margin:60px auto;padding:16px}
    .box{border:1px solid rgba(255,255,255,.08);border-radius:16px;padding:20px;margin:14px 0;background:rgba(10,11,28,.35); backdrop-filter:blur(3px); -webkit-backdrop-filter: blur(3px);}
    .info-row{display:flex;align-items:center;gap:12px;margin:16px 0;padding:12px;background:rgba(0,0,0,.18);border-radius:10px;border:1px solid rgba(255,255,255,.08)}
    .info-label{opacity:.7;font-size:.9rem;min-width:80px}
    .info-value{font-weight:500;color:#6ee7f3; font-size:.95rem;word-break:break-all; font-family: monospace;}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .msg-success{color:#6ee7f3;margin-top:12px}
    .msg-error{color:#ff7878;margin-top:12px}
    .notice-box{margin:16px 0;padding:14px;background:rgba(110,231,243,.08);border:1px solid rgba(110,231,243,.15);border-radius:10px;font-size:.9rem;line-height:1.6}
    .notice-box.warning{background:rgba(255,200,120,.08);border-color:rgba(255,200,120,.2);color:#ffffff}
    .notice-box.warning strong{color: rgb(255,200,120);}
    .section-title{margin-top:24px;margin-bottom:12px;opacity:.9;font-size:1.1rem;display:flex;align-items:center;gap:8px}
    hr{border:none;border-top:1px solid rgba(255,255,255,.08);margin:24px 0}
    .beta-badge{display:inline-block;padding:4px 10px;background:rgba(110,231,243,.15);border:1px solid rgba(110,231,243,.35);border-radius:6px;font-size:.75rem;font-weight:600;color:#6ee7f3;letter-spacing:.5px;margin-left:10px;vertical-align:middle}
    .modal{display:none;position:fixed;z-index:9999;left:0;top:0;width:100%;height:100%;overflow:auto;background:rgba(0,0,0,.85);backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
    .modal-content{background:rgba(20,21,40,.98);margin:8% auto;padding:32px;border:1px solid rgba(255,120,120,.3);border-radius:16px;max-width:520px;box-shadow:0 8px 32px rgba(255,120,120,.15)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-header h2{margin:0;color:#ff7878;display:flex;align-items:center;gap:10px}
    .close{color:#aaa;font-size:28px;font-weight:bold;cursor:pointer;line-height:1}
    .close:hover{color:#fff}
    .modal input[type="text"],.modal input[type="checkbox"]{margin:10px 0}
    .modal input[type="text"]{width:100%;padding:12px;background:rgba(0,0,0,.3);border:1px solid rgba(255,255,255,.15);border-radius:8px;color:#fff;font-size:1rem;font-family:monospace}
    .modal input[type="text"]:focus{outline:none;border-color:rgba(255,120,120,.5);background:rgba(0,0,0,.4)}
    .checkbox-row{display:flex;align-items:center;gap:10px;margin:16px 0;padding:12px;background:rgba(0,0,0,.2);border-radius:8px}
    .checkbox-row label{cursor:pointer;font-size:.8rem}
    .modal-actions{display:flex;gap:10px;margin-top:24px}
    .modal-actions .btn{flex:1}
  </style>
</head>
<body>
    <div class="background">
      <img class="logo-img" id="logoImg" src="assets/images/nexcore-logo.webp" alt="NexCore Labs Logo">
      <div id="spotLight" class="spot-light"></div>
    </div>

    <header class="navbar">
      <div class="nav-container">
        <div class="logo">
          <h1 id="logo">NexCore <span>Labs</span></h1>
        </div>

        <div class="dropdown">
        <div class="core-menu" id="coreMenu" aria-label="Open menu" title="Menu">
          <span class="dot" aria-hidden="true"></span>
          <span class="dot" aria-hidden="true"></span>
          <span class="dot" aria-hidden="true"></span>
          <span class="dot" aria-hidden="true"></span>
          <span class="dot" aria-hidden="true"></span>
          <span class="dot" aria-hidden="true"></span>
        </div>
        
     <div id="myDropdown" class="dropdown-content">
         <a href="auth.html" class="magic-signup fade" title="Sign in to your account">Access the Core</a>
         <input type="search" placeholder="What?..." id="myInput" onkeyup="filterFunction()" title="Search...">
         <a href="hub.html" class="fade" title="NexCore Labs Hub">Hub</a>
         <a href="hub.html#projects" class="fade" title="Projects">Projects</a>
         <div class="div-menu-line"></div>
         <a href="how-to-use.html" class="fade" title="How to Use NexCore Labs" style="margin-top: 0;">How to Use</a>
         <!-- <a href="pricing.html" class="fade" title="Pricing Plans">Pricing</a> -->
         <div class="div-menu-line"></div>
         <a href="index.html#tools" title="Tools & Systems" style="margin-top: 0;">Tools & Systems</a>
         <a href="index.html#about" title="About NexCore Labs">About Us</a>
         <a href="index.html#team" title="NexCore Labs Team">Our Team</a>
         <a href="index.html#contact" title="Contact NexCore Labs">Contact Us</a>
         <div class="div-menu-line"></div>
         <a href="faq.html" class="fade" title="FAQ & Support" style="margin-top: 0;">FAQ</a>
         <a href="terms.html" class="fade" title="Terms of Service">Terms</a>
         <a href="privacy-policy.html" class="fade" title="Privacy Policy">Privacy Policy</a>
     </div>
        </div>
      </div>
    </header>
    
    <main>
      <div class="wrap">
        <h1>Account Settings <span class="beta-badge">BETA</span></h1>

        <div class="box">
          <h2 style="margin-top:0;">Account Information</h2>

          <div class="info-row">
            <span class="info-label">Email:</span>
            <span class="info-value" id="userEmail">Loading...</span>
          </div>

          <div class="info-row">
            <span class="info-label">User ID:</span>
            <span class="info-value" id="userId">Loading...</span>
            <button class="btn copy" id="copyUserIdBtn" title="Copy User ID">
              <i class="fa-solid fa-copy"></i> Copy
            </button>
          </div>

          <div class="info-row">
            <span class="info-label">Created:</span>
            <span class="info-value" id="createdAt">Loading...</span>
          </div>

          <div class="info-row">
            <span class="info-label">Last sign in:</span>
            <span class="info-value" id="lastSignIn">Loading...</span>
          </div>
        </div>

        <div class="box">
          <h3 class="section-title"><i class="fa-solid fa-download"></i> Export Data</h3>
          <p class="muted" style="font-size:.9rem;">Download your account information and project data in JSON format.</p>
          
          <div class="row">
            <button class="btn primary ghost" id="exportAccountBtn">
              <i class="fa-solid fa-file-export"></i> Export My Account Data
            </button>
            <button class="btn primary ghost" id="exportProjectsBtn">
              <i class="fa-solid fa-folder-open"></i> Export My Projects
            </button>
          </div>
          <p id="exportMsg"></p>
        </div>

        <div class="box">
          <h3 class="section-title"><i class="fa-solid fa-right-from-bracket"></i> Session</h3>
          <p class="muted" style="font-size:.9rem;">Sign out of your NexCore Labs account.</p>
          <button class="btn logout" id="logoutBtn">
            <i class="fa-solid fa-right-from-bracket"></i> Log Out
          </button>
          <p id="logoutMsg"></p>
        </div>

        <div class="box">
          <h3 class="section-title"><i class="fa-solid fa-folder-open"></i> Project Data</h3>
          <p class="muted" style="font-size:.9rem;">Delete your project data. This will remove all your project information from NexCore Labs.</p>

          <div class="notice-box warning">
            <strong><i class="fa-solid fa-triangle-exclamation"></i> Warning:</strong> This action cannot be undone. Your project will be permanently deleted and removed from the hub.
          </div>

          <button class="btn danger" id="deleteProjectBtn">
            <i class="fa-solid fa-trash"></i> Delete My Project
          </button>
          <p id="deleteMsg"></p>
        </div>

        <div class="box">
          <h3 class="section-title"><i class="fa-solid fa-user-xmark"></i> Account Deletion</h3>
          <p class="muted" style="font-size:.9rem;">Permanently delete your NexCore Labs account and all associated data.</p>

          <div class="notice-box warning">
            <strong><i class="fa-solid fa-triangle-exclamation"></i> Warning:</strong> This action is <strong>irreversible</strong>. Deleting your account will:
            <ul style="margin:8px 0 0 20px;line-height:1.8">
              <li>Permanently delete all your projects and data</li>
              <li>Remove your account from NexCore Labs</li>
              <li>Log you out immediately</li>
            </ul>
          </div>

          <button class="btn danger" id="deleteAccountBtn">
            <i class="fa-solid fa-user-slash"></i> Delete Account
          </button>
        </div>

        <hr>

        <div class="box" style="background:rgba(0,0,0,.15);">
          <h3 class="section-title"><i class="fa-solid fa-circle-info"></i> Need Help?</h3>
          <p class="muted" style="font-size:.9rem;margin-bottom:12px;">
            If you have questions or need assistance with your account, please reach out to the NexCore Labs team.
          </p>
          <a href="/faq.html" class="btn primary ghost" style="margin-right:8px;"><i class="fa-solid fa-question-circle"></i> FAQ</a>
          <a href="/index.html#contact" class="btn primary ghost"><i class="fa-solid fa-envelope"></i> Contact Us</a>
        </div>
      </div>

      <!-- Delete Account Confirmation Modal -->
      <div id="deleteAccountModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h2><i class="fa-solid fa-triangle-exclamation"></i> Delete Account</h2>
            <span class="close" id="closeModal">&times;</span>
          </div>
          
          <p style="margin-bottom:16px;">This action is <strong>permanent and irreversible</strong>. All your data will be deleted.</p>
          
          <div class="notice-box warning" style="margin-bottom:20px;">
            <strong>This will delete:</strong>
            <ul style="margin:8px 0 0 20px;line-height:1.8">
              <li>All your projects</li>
              <li>Your account information</li>
              <li>All associated data</li>
            </ul>
          </div>
          
          <label for="confirmDeleteInput" style="display:block;margin-bottom:8px;opacity:.9">Type <strong>DELETE</strong> to confirm:</label>
          <input type="text" id="confirmDeleteInput" placeholder="DELETE" autocomplete="off">
          
          <div class="checkbox-row">
            <input type="checkbox" class="checkbox" id="confirmCheckbox">
            <label for="confirmCheckbox">I understand this action is irreversible and all my data will be permanently deleted</label>
          </div>
          
          <div class="modal-actions">
            <button class="btn" id="cancelDeleteBtn">
              <i class="fa-solid fa-xmark"></i> Cancel
            </button>
            <button class="btn danger" id="confirmDeleteBtn" disabled>
              <i class="fa-solid fa-trash"></i> Delete My Account
            </button>
          </div>
          
          <p id="modalMsg" style="margin-top:16px;"></p>
        </div>
      </div>
      
        <div class="nexcore-sign">
          <img id="nexcoreSign" src="assets/images/nexcore-word.webp" alt="NexCore Labs">
        </div>
      </main>

      <footer class="site-footer">
        <div class="container footer-inner">
          <div class="f-left">
            <a class="paypal" href="https://www.paypal.me/alfarismujahid" target="_blank" rel="noopener"><i class="fa-solid fa-heart" style="color: #6EE7F3;"></i> Support us on PayPal</a>
            <br>
            <small title="All Rights Reserved">NexCore Labs © <span id="year"></span> <span id="splitter">|</span>
              <a href="https://github.com/NexCoreLabs/NexCore/blob/main/LICENSE" target="_blank" class="license-link">
                <i class="fa-solid fa-scale-balanced"></i> MIT License
              </a>                <span class="footer-links"> | <a href="privacy-policy.html">Privacy Policy</a></span>            </small>
          </div>
          <div class="f-right footer-line"></div>
        </div>
      </footer>

  <script src="assets/js/script.js"></script>
  <script src="assets/js/supabase-client.js"></script>
  <script src="assets/js/auth-ui.js"></script>

  <script>
    const sb = window.supabaseClient;

    function setMsg(elId, text, isError = false) {
      const el = document.getElementById(elId);
      el.textContent = text || "";
      el.className = isError ? "msg-error" : "msg-success";
    }

    function downloadText(filename, text) {
      const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
    }

    async function requireAuth() {
      const { data: sessionData, error: sessionErr } = await sb.auth.getSession();
      if (sessionErr) {
        console.error("Session error:", sessionErr);
        window.location.href = "/auth.html";
        return null;
      }
      const session = sessionData?.session;
      if (!session) {
        window.location.href = "/auth.html";
        return null;
      }
      return session;
    }

    async function loadAccountInfo(session) {
      const user = session.user;
      
      document.getElementById("userEmail").textContent = user.email || "N/A";
      document.getElementById("userId").textContent = user.id || "N/A";
      
      const createdDate = user.created_at 
        ? new Date(user.created_at).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          })
        : "N/A";
      
      document.getElementById("createdAt").textContent = createdDate;
      
      const lastSignInDate = user.last_sign_in_at 
        ? new Date(user.last_sign_in_at).toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          })
        : "N/A";
      
      document.getElementById("lastSignIn").textContent = lastSignInDate;
    }

    async function logout() {
      try {
        const btn = document.getElementById("logoutBtn");
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Logging out...';
        
        await sb.auth.signOut();
        setMsg("logoutMsg", "Logged out successfully. Redirecting...");
        
        setTimeout(() => {
          window.location.href = "/auth.html";
        }, 1000);
      } catch (error) {
        setMsg("logoutMsg", error.message, true);
        document.getElementById("logoutBtn").disabled = false;
        document.getElementById("logoutBtn").innerHTML = '<i class="fa-solid fa-right-from-bracket"></i> Log Out';
      }
    }

    async function deleteProject() {
      const ok = confirm("⚠️ Delete your project permanently?\n\nThis will remove:\n• Your project from the hub\n• All project information\n• Your public page\n\nThis action CANNOT be undone.");
      if (!ok) return;

      const doubleCheck = confirm("Are you absolutely sure? This is your final warning.");
      if (!doubleCheck) return;

      try {
        const btn = document.getElementById("deleteProjectBtn");
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Deleting...';
        
        setMsg("deleteMsg", "");

        // Get user's session
        const { data: { session } } = await sb.auth.getSession();
        if (!session) {
          throw new Error("Not authenticated");
        }

        // Get user's project(s) - RLS ensures only user's projects are returned
        const { data: projects, error: fetchError } = await sb
          .from("projects")
          .select("*");

        if (fetchError) {
          throw new Error(fetchError.message);
        }

        if (!projects || projects.length === 0) {
          setMsg("deleteMsg", "No project found to delete.");
          btn.disabled = false;
          btn.innerHTML = '<i class="fa-solid fa-trash"></i> Delete My Project';
          return;
        }

        // Delete all user's projects (usually just one due to constraint)
        for (const project of projects) {
          const { error: deleteError } = await sb
            .from("projects")
            .delete()
            .eq("id", project.id);

          if (deleteError) {
            throw new Error(deleteError.message);
          }
        }

        setMsg("deleteMsg", "✓ Project deleted successfully.");
        btn.innerHTML = '<i class="fa-solid fa-check"></i> Deleted';
        
        setTimeout(() => {
          window.location.href = "/dashboard.html";
        }, 2000);
      } catch (error) {
        setMsg("deleteMsg", "Error: " + error.message, true);
        const btn = document.getElementById("deleteProjectBtn");
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-trash"></i> Delete My Project';
      }
    }

    async function exportAccountData() {
      try {
        const btn = document.getElementById("exportAccountBtn");
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Exporting...';
        
        const { data: { session } } = await sb.auth.getSession();
        if (!session) {
          throw new Error("Not authenticated");
        }

        const user = session.user;
        const exportData = {
          email: user.email,
          user_id: user.id,
          created_at: user.created_at,
          last_sign_in_at: user.last_sign_in_at,
          export_date: new Date().toISOString(),
          export_source: "NexCore Labs Account Settings"
        };

        // Generate timestamp for filenames
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
        const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, ''); // HHmmss
        const timestamp = `${dateStr}_${timeStr.substring(0, 4)}`; // YYYY-MM-DD_HHmm
        const baseFilename = `nexcorelabs_account_${user.id.substring(0, 8)}_${timestamp}`;

        // Export JSON
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${baseFilename}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Export TXT (human-readable)
        const createdDate = user.created_at 
          ? new Date(user.created_at).toLocaleString('en-US', { 
              dateStyle: 'medium', 
              timeStyle: 'short' 
            })
          : "N/A";
        
        const lastSignIn = user.last_sign_in_at 
          ? new Date(user.last_sign_in_at).toLocaleString('en-US', { 
              dateStyle: 'medium', 
              timeStyle: 'short' 
            })
          : "N/A";

        const txtContent = `========================================
NexCore Labs - Account Data Export
========================================

Export Time: ${new Date().toISOString()}

--- Account Information ---

Email: ${user.email || "N/A"}
User ID: ${user.id || "N/A"}
Account Created: ${createdDate}
Last Sign In: ${lastSignIn}

========================================
End of Export
========================================
`;

        downloadText(`${baseFilename}.txt`, txtContent);

        setMsg("exportMsg", "✓ Account data exported (JSON + TXT).");
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-file-export"></i> Export My Account Data';
      } catch (error) {
        setMsg("exportMsg", "Error: " + error.message, true);
        const btn = document.getElementById("exportAccountBtn");
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-file-export"></i> Export My Account Data';
      }
    }

    async function exportProjects() {
      try {
        const btn = document.getElementById("exportProjectsBtn");
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Exporting...';
        
        const { data: { session } } = await sb.auth.getSession();
        if (!session) {
          throw new Error("Not authenticated");
        }

        // Get user's project(s) - RLS ensures only user's projects are returned
        const { data: projects, error } = await sb
          .from("projects")
          .select("*");

        if (error) {
          throw new Error(error.message);
        }

        const projectCount = projects?.length || 0;
        
        // Generate timestamp for filenames
        const now = new Date();
        const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD
        const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, ''); // HHmmss
        const timestamp = `${dateStr}_${timeStr.substring(0, 4)}`; // YYYY-MM-DD_HHmm
        const baseFilename = `nexcorelabs_projects_${session.user.id.substring(0, 8)}_${timestamp}`;

        const exportData = {
          user_id: session.user.id,
          export_date: new Date().toISOString(),
          project_count: projectCount,
          projects: projects || [],
          export_source: "NexCore Labs Account Settings"
        };

        // Export JSON
        const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${baseFilename}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        // Export TXT (human-readable)
        let txtContent = `========================================
NexCore Labs - Projects Export
========================================

Export Time: ${new Date().toISOString()}
User ID: ${session.user.id}
Email: ${session.user.email || "N/A"}

--- Projects Summary ---

Total Projects: ${projectCount}

`;

        if (projectCount === 0) {
          txtContent += "Projects: 0 (no projects found).\n";
        } else {
          txtContent += "========================================\n";
          projects.forEach((project, index) => {
            txtContent += `\nProject #${index + 1}\n`;
            txtContent += `-------------------\n`;
            txtContent += `ID: ${project.id || "N/A"}\n`;
            txtContent += `Public ID: ${project.public_id || "N/A"}\n`;
            txtContent += `Name: ${project.name || "Untitled"}\n`;
            txtContent += `Slug: ${project.slug || "N/A"}\n`;
            txtContent += `Description: ${project.description || "No description"}\n`;
            txtContent += `Status: ${project.published ? "Published" : "Draft"}\n`;
            
            if (project.created_at) {
              const createdDate = new Date(project.created_at).toLocaleString('en-US', { 
                dateStyle: 'medium', 
                timeStyle: 'short' 
              });
              txtContent += `Created At: ${createdDate}\n`;
            }
            
            if (project.image_url) {
              txtContent += `Image URL: ${project.image_url}\n`;
            }
            if (project.website) {
              txtContent += `Website: ${project.website}\n`;
            }
            if (project.github_url) {
              txtContent += `GitHub: ${project.github_url}\n`;
            }
            if (project.x_url) {
              txtContent += `X (Twitter): ${project.x_url}\n`;
            }
            if (project.instagram_url) {
              txtContent += `Instagram: ${project.instagram_url}\n`;
            }
            if (project.linkedin_url) {
              txtContent += `LinkedIn: ${project.linkedin_url}\n`;
            }

            txtContent += `\n`;
          });
        }

        txtContent += `\n========================================\nEnd of Export\n========================================\n`;

        downloadText(`${baseFilename}.txt`, txtContent);

        setMsg("exportMsg", `✓ ${projectCount} project(s) exported (JSON + TXT).`);
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-folder-open"></i> Export My Projects';
      } catch (error) {
        setMsg("exportMsg", "Error: " + error.message, true);
        const btn = document.getElementById("exportProjectsBtn");
        btn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-folder-open"></i> Export My Projects';
      }
    }

    function openDeleteAccountModal() {
      const modal = document.getElementById("deleteAccountModal");
      modal.style.display = "block";
      document.getElementById("confirmDeleteInput").value = "";
      document.getElementById("confirmCheckbox").checked = false;
      document.getElementById("confirmDeleteBtn").disabled = true;
      setMsg("modalMsg", "", false);
    }

    function closeDeleteAccountModal() {
      const modal = document.getElementById("deleteAccountModal");
      modal.style.display = "none";
    }

    function checkDeleteConfirmation() {
      const input = document.getElementById("confirmDeleteInput").value;
      const checkbox = document.getElementById("confirmCheckbox").checked;
      const btn = document.getElementById("confirmDeleteBtn");
      
      btn.disabled = !(input === "DELETE" && checkbox);
    }

    function buildDeleteError(result, fallback) {
      let msg = result?.details || result?.error || result?.message || fallback || "Account deletion failed";
      if (result?.step) {
        msg = `[${result.step}] ${msg}`;
      }
      if (result?.code) {
        msg += ` (code: ${result.code})`;
      }
      if (result?.hint) {
        msg += `\nHint: ${result.hint}`;
      }
      return msg;
    }

    async function confirmDeleteAccount() {
      const btn = document.getElementById("confirmDeleteBtn");
      const cancelBtn = document.getElementById("cancelDeleteBtn");
      
      try {
        btn.disabled = true;
        cancelBtn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Deleting...';
        
        setMsg("modalMsg", "Deleting account...");

        // Retrieve session using Supabase v2 API
        const { data, error } = await sb.auth.getSession();
        if (error) {
          throw new Error("Failed to read session: " + error.message);
        }

        const token = data?.session?.access_token;
        if (!token) {
          throw new Error("No active session, please log in again.");
        }

        console.log("Delete token length:", token?.length);

        // Call server-side delete account API with Bearer token
        const response = await fetch("/api/delete-account", {
          method: "POST",
          headers: {
            "Authorization": `Bearer ${token}`,
            "Content-Type": "application/json",
            "Accept": "application/json"
          },
          body: JSON.stringify({})
        });

        // Log raw response for diagnosis
        console.log("delete-account status:", response.status);
        const raw = await response.text();
        console.log("delete-account raw:", raw);

        // Parse the response safely
        let result = {};
        try {
          result = JSON.parse(raw);
        } catch (parseError) {
          console.error("Failed to parse response as JSON:", parseError);
          result = { error: raw || "Unknown error from server" };
        }

        // Check if response is not ok
        if (!response.ok) {
          const fallback = raw || `HTTP ${response.status}`;
          throw new Error(buildDeleteError(result, fallback));
        }

        // Check if the response indicates success
        if (!result.ok) {
          // Even if response.ok, the result might indicate failure
          throw new Error(buildDeleteError(result));
        }

        // Success
        setMsg("modalMsg", "✓ Account deleted successfully. Redirecting...");
        
        // Sign out locally
        await sb.auth.signOut();
        
        setTimeout(() => {
          window.location.href = "/auth.html?deleted=1";
        }, 2000);
      } catch (error) {
        console.error("Delete account error:", error);
        setMsg("modalMsg", "Error: " + error.message, true);
        btn.disabled = false;
        cancelBtn.disabled = false;
        btn.innerHTML = '<i class="fa-solid fa-trash"></i> Delete My Account';
      }
    }

    async function copyUserId() {
      const userIdText = document.getElementById("userId").textContent;
      const btn = document.getElementById("copyUserIdBtn");
      
      if (userIdText === "Loading..." || userIdText === "N/A") return;
      
      try {
        await navigator.clipboard.writeText(userIdText);
        
        // Visual feedback
        const originalHTML = btn.innerHTML;
        btn.classList.add("copied");
        btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
        
        setTimeout(() => {
          btn.classList.remove("copied");
          btn.innerHTML = originalHTML;
        }, 2000);
      } catch (error) {
        console.error("Failed to copy:", error);
        btn.innerHTML = '<i class="fa-solid fa-xmark"></i> Failed';
        setTimeout(() => {
          btn.innerHTML = '<i class="fa-solid fa-copy"></i> Copy';
        }, 2000);
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const session = await requireAuth();
      if (!session) return;

      // Monitor for session loss
      sb.auth.onAuthStateChange((_event, session) => {
        if (!session) {
          console.log("Session lost, redirecting to auth page");
          window.location.href = "/auth.html";
        }
      });

      await loadAccountInfo(session);

      // Button event listeners
      document.getElementById("logoutBtn").addEventListener("click", logout);
      document.getElementById("deleteProjectBtn").addEventListener("click", deleteProject);
      document.getElementById("copyUserIdBtn").addEventListener("click", copyUserId);
      document.getElementById("exportAccountBtn").addEventListener("click", exportAccountData);
      document.getElementById("exportProjectsBtn").addEventListener("click", exportProjects);
      document.getElementById("deleteAccountBtn").addEventListener("click", openDeleteAccountModal);
      
      // Modal event listeners
      document.getElementById("closeModal").addEventListener("click", closeDeleteAccountModal);
      document.getElementById("cancelDeleteBtn").addEventListener("click", closeDeleteAccountModal);
      document.getElementById("confirmDeleteBtn").addEventListener("click", confirmDeleteAccount);
      document.getElementById("confirmDeleteInput").addEventListener("input", checkDeleteConfirmation);
      document.getElementById("confirmCheckbox").addEventListener("change", checkDeleteConfirmation);
      
      // Close modal when clicking outside
      window.addEventListener("click", (event) => {
        const modal = document.getElementById("deleteAccountModal");
        if (event.target === modal) {
          closeDeleteAccountModal();
        }
      });
    });
  </script>
  <script src="assets/js/cookie-consent.js" defer></script>
</body>
</html>
